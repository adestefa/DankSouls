--[[
============================================
    Dank Souls v1.0  1:43 AM 10/21/2015
	- Volume I: Consequences - by CoreLogic
=============================================

	<b>[What is it?]</b>
	A fun mod that transforms GTA V into a new, harder game without cops that really doesn't like you (think Dark Souls I)
	
	<b>[Prepare to die!]</b>
	The Dark Souls of GTA V. Every ped you kill (soul), gives me three tries (Dank Souls) to kill you. Play against me and see how long you can stay alive. 
	
	Note: If you stay the model citizen, nothing will happen. In fact, you can do whatever you want, the cops will never show up if crash or shoot around. 
		  The game starts when you make a kill, or a ped dies near you.
		
	<b>[Manual]</b>
	Dank Souls is a fun new way to play GTA V without cops. I set out to design a mod that will turn your kills into my army.
	What if I could use dead peds and change them into a series of custom AI foes, each leading up to a mini-boss fight.
	
	A series of foes from a single ped's death is called a "Wave". Each wave has three MFs, the last being the boss.
	Instead of the undead zombie games, think Asteroids. The more you hit, the more you have to clean up, and the harder it gets to do it!
	Exactly like Asteroids, using simple rules we get interesting complex gameplay just starting with a few kills. 
	
	The end result is, the more you kill--the harder you fight, the harder the game will fight back. 
	
			
	<b>[Rules]</b>
	- After you kill any ped, you hand their soul over to me.
	- Every ped you kill will now turn into a Dank Soul and give me three tries to kill you.
	- Each dead ped lets me spawn a Wave (made up of 3 succesive enemies over 5 levels of difficulty)
	- The last enemy in a wave is a boss that will get right to business, so be ready!

      <b> [Game Play]</b>	
	Each kill you make now has consequences. 
	When the Wave counter reaches zero it is my turn. At timed intervals (waves) I am allowed to make my move and reclaim the dead into my army. 
		
     <b>[Your turn]</b>
	Kill any number of nearby peds before the Wave timer runs out.
	
    <b>[My turn]</>
	Starts when the Wave timer reaches zero (located at the center bottom of the game screen).
    At the end of each wave countdown, my complex move consists of the following:
	  1) turn any dead peds into Zombies
	  2) turn any dead zombies into demons
	  3) turn any dead demons into bosses
	  4) drop resources for each dead enemy type
	
	Example Dank Wave started by killing a single ped:
	  [Ped] -> [Zombie] -> [Demon] -> [Boss] -> [Resource drops!]
	
	<b>[Wave countdown]</b>
	Depending on the level, the wave timer may count down from 300 and slowing get faster and faster. 
    
	Note: the UI will flash 3 times when the wave is about to end, so you can focus on fighting and still know when a wave is ending without looking. 
	If you are good enough to stay alive and kill me, I will spawn another, harder apponent at the next wave's end.
	    	
	Each level will be more intense than the last.
	Reach the boss of each wave, kill him for needed armor and rocket ammo.

		
	<b>[Know Thy Enemy]</b>	
	Each killed ped will spawn a single wave of Dank Souls.
				
	<b>A single Wave consists of three Dank Souls</b>
	- First  Zombie (white  blip #1)
	- Second Demon  (orange blip #2)
	- Third  Boss   (pink   blip #3)
	
	<b>[Meet the Danks]</b>
	Zombie:  Simple minded, starts with pistol on lower levels with varying accuracy. Watch out, they can be deadly in packs!
	 - Drops: Money, health, pistol/rifle ammo
	
	Demon: More aggressive, they start with AR-15 and get a grenade launcher and rockets in later levels. Watch your back, they will be out front if around.
	 - Drops: Money, health, rifle/grenade ammo
	 
	Boss: Mean as it gets. Will hang back more and lurk sending a rocket your way when you lest expect if if you are not careful. Manage these guys carefully. They don't fuck around. If you are not anticipating where and when each boss is spawning around you, you are hopelessly doomed. The only weakness they have is at lower level they have very bad aim, that said, rockets have a big blast area. Use the lower level Bosses to train for target management you will need in later levels. Use that Mini-map or die!
	 - Drops: Money, health, Armour, rocket ammo
	
	Each will drop resources when killed, guns, ammo, money, health.. but a boss will also drop Armour and rockets.
	Danks start out with limited accuracy and weapons, but will quickly become more accurate and deadly as you level up.

    Only five levels of difficulty and infinite long play. 
	Each level will bring new enemy abilities and a single vehicle as a reward. Use it wisely, even a tank is no match for a gang of Bosses.
	
	There are only five levels of AI difficulty and are tied to how many waves you have completed.
	The more Dank Souls you are fighting at once, and the move waves you complete (bosses) the faster you will level up and the harder they will become.	

	<b>[Levels]</b>
	1) <5 waves:  1 Bike, Enemies: Lower accuracy, simple weapons         (training) 
	2) <10 waves: 1 Bulldozer, Enemies:improved accuracy, more aggressive (training)
	3) <15 waves: 1 Tank, Enemies: New weapons, better accuracy, faster waves!
	4) <20 waves: 1 Annihilator, Enemies: Really insane now, better take it slow, faster waves!
	5) >30 waves: 1 Annihilator, Enemies: Impossible to stay alive. Instant waves. Good Luck.
	
	
	<b>[Strategy]</b>
	This mini-game is all about resource and target management. COD run-and-gun will be chewed up quickly here if you kill more than one ped at a time. 
	Only the smart and determined, who use all their weapons and mini-map, ploting each kill and it's consequences will stay alive.
		
	This Mod is not for the faint of heart. The harder you fight me, the harder I fight back. The more you kill, the more you have to kill.
	For those sick of fighting the cops, this mod is for you. The slower you fight the easier the system will respond. Light up a whole block on level 3 and up and you have an army ready to skull fuck you.
	
	"That escalated quickly" is heard a lot when playing. 
	The logic starts off easy and becomes ruthless and smart quickly as you level up, don't be fooled even a tank will have a challenge when a few Bosses are around.
	
	<b>[Tips]</b>
	 - There are no cops, do whatever you want
	 - If you make no kills nothing will happen
	 - When you do kill, manage how many waves you start. 
	 - Watch the Wave count down timer. when it reaches zero, all dead will be resurrected.
	 - An audible deep sound will fire for each new Dank. Use this as another clue just how many new enemies are around.
	 - Use the mini-map, solid color blips are dead, the ones with numbers are real targets
	 - watch out for #3s! (bosses)
	 - Blip colors: white: zombie, orange: demon, pink: boss
	 - Use the topography to your advantage, cover, cover, cover, but don't be too far from pickups after finishing a wave.
	 - Watch all sides!
	 - Just like the real Dark Souls, lure packs into choke points and pick off one at a time. 
	 - Rockets and grande launchers at higher levels can be insane. Plan accordingly. 
	 - Pace yourself! Just like running too far ahead in Dark Souls, sometimes you simply kill too many peds and death is inevitable. 
	 
	 I'm gonna kick your ass. I warned you.

	[Installation]
	 1. Install Script Hook https://www.gta5-mods.com/tools/script-hook-v
	 2. Install the LUA script plugin for Scripthook https://www.gta5-mods.com/tools/lua-plugin-for-script-hook-v
	 3. Download the DankSouls.lua file
	 4. Put the <b>DankSouls.lua</b> file in your <install dir>\Grand Theft Auto V\scripts\addins folder.
	 5. Text will appear above the mini-map when installed correctly

	 
	[Thanks]
	Rockstar, for giving us a masterpiece. The guys that make OpenIV, and Alexander Blade who are both absolute treasures to the modding world of GTA and the modding community for creating such a great place in an insane world.
 -------------------------------
 version 1.9.6.9 10/21/2015
  - base version
 version 1.9.7.1 11/29/2015
   - Mayhem now gets full load-out
   - Wanted level now rises on all modes except Chicken
   - Chicken game mode now has improved zombie spawn 
   - Level 1 now gets Annihilator helicopter
   - Level 5 now gets full load-out in all game modes  
   - Fixed bug spawning helicopter on top of player
   - Fixed bug spawned vehicles stay on map after game over
   - Fixed death count bug on game over screen
   - You can turn cops off by setting <b>DS.settings["cops_ignore"]</b>  to true
 
]]--
local DS = {};
--  Game Settings
-- =================================
DS.settings = {};
DS.settings["health_as_a_resource"] = false;	-- Collect and carry health packs when true, drop on dead Danks when false
DS.settings["cops_ignore"] = false;				-- A lot easier without the cops, set as you like
DS.settings["key_1"]=49; 						-- Game mode 1 activation key (set to '1' by default)
DS.settings["key_2"]=50; 						-- Game mode 2 activation key (set to '2' by default)
DS.settings["key_3"]=51; 						-- Game mode 3 activation key (set to '3' by default)
DS.settings["key_help"]=72;						-- Game help screen activation key (set to 'h' by default)
-- ==================================================
-- ==================================================
-- ===== EDIT BELOW AT OWN RISK! ====================
-- ==================================================
-- ==================================================
DS.settings["dialog_cooldown"] = 750;
DS.settings["spawn_cooldown"] = 550;
DS.settings["opening_sequence_cooldown"] = 4100;
DS.settings["invincible"] = false;			-- Player can not take damage when true
DS.settings["score_zombie"] = 50;			-- points for killing a zombie
DS.settings["score_demon"] = 100;			-- points for killing a demon
DS.settings["score_boss"] = 500;            -- points for killing a boss
DS.settings["score_bonus_total_kills"] = 25; -- bonus points per kill
DS.settings["pedCheckDelay"] = 50;			-- delay in ticks before scanning and adding new peds to DS.data['seenPeds']
DS.settings["deathCheckDelay"] = 300;	    -- delay in ticks before scanning for dead peds in DS.data['seenPeds']
DS.settings["blip_update_delay"] = 60;       -- delay between redrawing blips on radar for each Dank
DS.settings["blip_color_zombie"] = 2;		-- green
DS.settings["blip_color_demon"] = 17;		-- orange
DS.settings["blip_color_boss"] = 23;			-- pink 
DS.settings["game_mode"] = 0; -- 1 = prepare to die, 2 = Hardcore (3 lives), 3 = Eat every fucking chicken
-- objects to track level details (weapons and accuracy for all Dank types)
-- ==============================
DS.settings["level_weapons_zombie"] = {};
DS.settings["level_accuracy_zombie"] = {};
DS.settings["level_weapons_demon"] = {};
DS.settings["level_accuracy_demon"] = {};
DS.settings["level_weapons_boss"] = {};
DS.settings["level_accuracy_boss"] = {};
DS.settings["level_deathCheckDelay"] = {};
DS.settings["chicken_spawn_zombie_delay"] = 300;  -- delay in game ticks chicken will spawn a Dank Soul
DS.settings["chicken_active_enemy_count"] = 3; 	  -- number of active Dank Souls required before Chicken doesn't spawn
DS.settings["level_chicken_spawn_distance"] = {}  -- how far will chicken spawn each level
-- Define how many waves of Danks a player must complete to finish a level
-- ============================================
DS.settings["level_1_finished_waves"] = 5;  -- 5how many waves to complete level 1?
DS.settings["level_2_finished_waves"] = 10; -- 10how many waves to complete level 2? 
DS.settings["level_3_finished_waves"] = 15; -- 15etc...
DS.settings["level_4_finished_waves"] = 20;
DS.settings["level_5_finished_waves"] = 25;
DS.settings["level_6_game_overtime"] = 30;  -- bonus round after all levels, infinite scoring... no game over
-- ==== LEVEL 1 ===============================
DS.settings["level_deathCheckDelay"][1] = 800;
DS.settings["level_weapons_zombie"][1] = GAMEPLAY.GET_HASH_KEY("WEAPON_COMBATPISTOL");
DS.settings["level_accuracy_zombie"][1] = 50;
DS.settings["level_weapons_demon"][1] = GAMEPLAY.GET_HASH_KEY("WEAPON_CARBINERIFLE");
DS.settings["level_accuracy_demon"][1] = 50;
DS.settings["level_weapons_boss"][1] =  GAMEPLAY.GET_HASH_KEY("WEAPON_RPG");
DS.settings["level_accuracy_boss"][1] = 20;
DS.settings["level_chicken_spawn_distance"][1] = 8.0;
-- ==== LEVEL 2 ===============================
DS.settings["level_deathCheckDelay"][2] = 500;
DS.settings["level_weapons_zombie"][2] = GAMEPLAY.GET_HASH_KEY("WEAPON_MICROSMG");
DS.settings["level_accuracy_zombie"][2] = 60;
DS.settings["level_weapons_demon"][2] = GAMEPLAY.GET_HASH_KEY("WEAPON_CARBINERIFLE");
DS.settings["level_accuracy_demon"][2] = 65;
DS.settings["level_weapons_boss"][2] =  GAMEPLAY.GET_HASH_KEY("WEAPON_RPG");
DS.settings["level_accuracy_boss"][2] = 70;
DS.settings["level_chicken_spawn_distance"][2] = 10.0;
-- ==== LEVEL 3 ===============================
DS.settings["level_deathCheckDelay"][3] = 500;
DS.settings["level_weapons_zombie"][3] = GAMEPLAY.GET_HASH_KEY("WEAPON_CARBINERIFLE");
DS.settings["level_accuracy_zombie"][3] = 95;
DS.settings["level_weapons_demon"][3] = GAMEPLAY.GET_HASH_KEY("WEAPON_CARBINERIFLE");
DS.settings["level_accuracy_demon"][3] = 85;
DS.settings["level_weapons_boss"][3] =  GAMEPLAY.GET_HASH_KEY("WEAPON_RPG");
DS.settings["level_accuracy_boss"][3] = 80;
DS.settings["level_chicken_spawn_distance"][3] = 15.0;
-- ==== LEVEL 4 ===============================
DS.settings["level_deathCheckDelay"][4] = 500;
DS.settings["level_weapons_zombie"][4] = GAMEPLAY.GET_HASH_KEY("WEAPON_CARBINERIFLE");
DS.settings["level_accuracy_zombie"][4] = 95;
DS.settings["level_weapons_demon"][4] = GAMEPLAY.GET_HASH_KEY("WEAPON_GRENADELAUNCHER");
DS.settings["level_accuracy_demon"][4] = 90;
DS.settings["level_weapons_boss"][4] =  GAMEPLAY.GET_HASH_KEY("WEAPON_RPG");
DS.settings["level_accuracy_boss"][4] = 90;
DS.settings["level_chicken_spawn_distance"][4] = 20.0;
-- ==== LEVEL 5 ===============================
DS.settings["level_deathCheckDelay"][5] = 500
DS.settings["level_weapons_zombie"][5] = GAMEPLAY.GET_HASH_KEY("WEAPON_CARBINERIFLE");
DS.settings["level_accuracy_zombie"][5] = 100;
DS.settings["level_weapons_demon"][5] = GAMEPLAY.GET_HASH_KEY("WEAPON_GRENADELAUNCHER");
DS.settings["level_accuracy_demon"][5] = 100;
DS.settings["level_weapons_boss"][5] =  GAMEPLAY.GET_HASH_KEY("WEAPON_RPG");
DS.settings["level_accuracy_boss"][5] = 100;
DS.settings["level_chicken_spawn_distance"][5] = 25.0;
--  Game State Registers (run-time)
-- =================================
DS.data = {};
DS.data["version"] = "1.9.7.1";
DS.data["seenPeds"] = {};
DS.data["seenPedSkins"] = {};
DS.data["seenAllPeds"] = {};
DS.data["finished_wave"] = {};
DS.data["zombies"] = {};
DS.data["demons"] = {};
DS.data["bosses"] = {};
DS.data["blips"] = {};
DS.data["playGame"] = false;
DS.data["run"] = false;
DS.data["bounus_round"] = false;
DS.data["death"] = false;
DS.data["lives"] = 3;
DS.data["game_over"] = false;
DS.data["bad_coords"] = false;
DS.data["health_count"] = 0;
DS.data["active_threat"] = "";
DS.data["settings_ignore"] = true;
DS.data["level"] = 1;
DS.data["score"] = 0;
DS.data["deaths"] = 0;
DS.data["finished_level"] = 0;
DS.data["skinhash_zombie"] = "nil";
DS.data["skinhash_demon"] =  "nil";
DS.data["skinhash_boss"] =  "nil";
DS.data["skinhash_chicken"] = "nil";
DS.data["max_num_Dank"] = 0;
DS.data["reward_earned"] = false;
DS.data["reward_not_claimed"] = false;
DS.data["reward_vech_name"] = "Akuma Bike";
DS.data["last_coords"] = {};
DS.data["last_coords"].x = 0.0;
DS.data["last_coords"].y = 0.0;
DS.data["last_coords"].z = 0.0;
DS.data["location_before_teleport"] = {};
DS.data["chicken"] = nil;
DS.data["chicken_in_play"] = false;
DS.data["chicken_active_enemy_count"] = 0;
DS.data["chicken_zombies"] = 0;
DS.data["total_deaths"] = 1; -- should never be reset!
DS.data["chicken_timer_up"] = false;
DS.data["chicken_total"] = 0;
DS.data["wave_progression"] = false;
DS.data["has_flask"] = false; -- has player found health flask yet?
DS.data["slow_time"] = false;
DS.data["vehicles"] = {};
-- Dank skins
-- ==================
DS.hell = {}
DS.hell["zombie"] = "u_m_y_zombie_01";
DS.hell["demon"] = "a_m_y_juggalo_01";
DS.hell["boss"] = "s_m_y_clown_01";
DS.hell["chicken"] = "a_c_hen";
-- On Death Game Tips
-- ==================
DS.data["show_help"] = false;
DS.data["tip_pointer"] = 0;
DS.data["tips_1"] = {};
DS.data["tips_2"] = {};
DS.data["tips_3"] = {};
-- mode 1 - Mayhem 
-- ==================
DS.data["tips_1"][1] = "The more peds you kill, the harder the game will fight back. Pace yourself.";
DS.data["tips_1"][2] = "Watch the spawn timer, get to cover before it reaches zero.";
DS.data["tips_1"][3] = "Press the 'L' key after respawn to return to your last bloodstain and keep the fight going!";
DS.data["tips_1"][4] = "The mini-map is critical, use it to anticipate what is spawning next wave.";
DS.data["tips_1"][5] = "Each Dank that spawns gives you some invincibility, be aggressive!";
DS.data["tips_1"][6] = "Each Dank will drop goodies, each boss will drop a body armor half plate.";
DS.data["tips_1"][7] = "Kills don't count for a wave until you also kill the boss!";
DS.data["tips_1"][8] = "Use Michael's special ability to slow down time and take out a horde.";
DS.data["tips_1"][9] = "Take off auto-aim, use first-person view for best experience. Ctrl-pad to lob granades while firing.";
-- mode 2 -- HardCore
-- ==================
DS.data["tips_2"][1] = "The mini-map is critical, use it to anticipate what is spawning.";
DS.data["tips_2"][2] = "Watch the spawn timer, get to cover before it reaches zero.";
DS.data["tips_2"][3] = "Keep under cover, watch for rockets on your reload.";
DS.data["tips_2"][4] = "Kills during a wave don't count until you also kill the boss.";
DS.data["tips_2"][5] = "Take off auto-aim, use first-person view for best experience. Ctrl-pad to lob granades while firing.";
-- mode 3 -- Chicken
-- ==================
DS.data["tips_3"][1] = "Shoot the chicken as soon as it spawns.";
DS.data["tips_3"][2] = "Press 'L' key after respawn to return to your last bloodstain and keep chasing the chicken!";
DS.data["tips_3"][3] = "Watch the spawn timer, get to cover before it reaches zero.";
DS.data["tips_3"][4] = "Kills during a wave don't count until you also kill the boss.";
DS.data["tips_3"][5] = "Run, Run, Run, aggression is key!";
DS.data["tips_3"][6] = "The mini-map is critical, use it to anticipate what is spawning next wave.";
DS.data["tips_3"][7] = "Each Dank that spawns gives you some invincibility, be aggressive!";
DS.data["tips_3"][8] = "Each Dank will drop goodies, each boss will drop body armor half plate.";
DS.data["tips_3"][9] = "Kills don't count for a wave until you also kill the boss!";
DS.data["tips_3"][10] = "Use Michael's special ability to slow down time and take out a horde.";
DS.data["tips_3"][11] = "Take off auto-aim, use first-person view for best experience. Ctrl-pad to lob granades while firing.";

--   Timers
-- ==================
DS.timer = {};
-- how long before the next wave is resurrected
DS.timer["deathCheck"] =  DS.settings["deathCheckDelay"];
-- how long before we scan for new peds
DS.timer["pedCheck"] = DS.settings["pedCheckDelay"];
-- how long before we update Dank blip on minimap
DS.timer["blip"] = DS.settings["blip_update_delay"];
DS.timer["spawn_timer"] = 200;
DS.timer["new_level_reached"] = 0;
DS.timer["godmode"] = 0;
DS.timer["chicken"] = 5000;
DS.timer["Countdown_timer"] = 2000;
-- Toggles
-- ==================
DS.toggle = {};
DS.toggle["spawn_dialog"] = false;
DS.toggle["new_level_reached"] = false;
DS.toggle["godmode"] = false;
DS.toggle["chicken_free_roam"] = false;
DS.toggle["game_scanner"] = true;
DS.toggle["chicken_is_loose"] = false;
DS.toggle["health_flask"]=false;
-- Utilities
-- ==================
function DS.showTip()
	DS.data["tip_pointer"] = DS.data["tip_pointer"] + 1;
	print("DS::showTip::ptr:"..DS.data["tip_pointer"]);
	if (DS.settings["game_mode"] == 1) then
		if(#DS.data["tips_1"] > DS.data["tip_pointer"]) then
			return "Tip: "..DS.data["tips_1"][DS.data["tip_pointer"]];
		else
			return "Tip: Don't bet on the horses";
		end
	elseif(DS.settings["game_mode"] == 2) then
		if(#DS.data["tips_2"] > DS.data["tip_pointer"]) then
			return "Tip: "..DS.data["tips_2"][DS.data["tip_pointer"]];
		else
			return "Tip: Don't bet on the horses";
		end
	elseif(DS.settings["game_mode"] == 3) then
		if(#DS.data["tips_3"] > DS.data["tip_pointer"]) then
			return "Tip: "..DS.data["tips_3"][DS.data["tip_pointer"]];
		else
			return "Tip: Keep moving forward.";
		end
	else
		-- something really bad happened..
		return "Unknown state:"..DS.settings["game_mode"];
	end
end
function DS.giveMoney(amount)
  local playerPosition = ENTITY.GET_ENTITY_COORDS(PLAYER.PLAYER_PED_ID(), false);
  OBJECT.CREATE_AMBIENT_PICKUP(GAMEPLAY.GET_HASH_KEY("PICKUP_MONEY_VARIABLE"), playerPosition.x, playerPosition.y, playerPosition.z, 0, amount, 1, false, true);
  print("give money");
 end
 -- increment global health count var
 function DS.giveHealth(amount, coord)
	-- use health as an inventory resource
	if (DS.settings["health_as_a_resource"]) then
		DS.data["health_count"] = DS.data["health_count"] + 1;
		if(DS.data["health_count"] > 3) then
			DS.data["health_count"] = 3;
		end
		print("giveHealth::Health count:"..DS.data["health_count"]);
	else
		print("DS::giveHealth::"..amount);
		-- health will drop on dead hellspawn
		DS.dropHealth(amount, coord);
	end
 end
 -- drop health pack
 function DS.dropHealth(amount, coord)
    local hp = OBJECT.CREATE_AMBIENT_PICKUP(-1888453608, coord.x, coord.y, coord.z, 0, amount, 1, false, true);
	print("DS::dropHealth:health:"..hp);
 end
 -- spawn health on player from inventory
 function DS.spawnHealth()
    print("spawnHealth::Health count:"..DS.data["health_count"]);
	-- player drinks health juice
	if (DS.data["health_count"] > 0) then
		DS.data["health_count"] = DS.data["health_count"] - 1;
		local coord = ENTITY.GET_ENTITY_COORDS(PLAYER.PLAYER_PED_ID(), false);
		DS.dropHealth(100, coord);
		-- give invincibility
		DS.godOn(5);
		DS.godAddTime(500);
	else
		print("spawnHealth::not enough!");
	end
 end
-- show Health pack Hud
function DS.drawHealthPackASCIILine()
	if(DS.settings["health_as_a_resource"]) then
		local ln = "";
		for i=1,DS.data["health_count"] do
		  ln = ln .. "|";
		end
		if(DS.data["health_count"] == 0) then
		 ln = "0";
		end
		ln = " [J] Health Juice: "..ln;
		DS.drawText(ln, 0.77, 0.00005, 0.3, false, 1, 255, 255, 0);
	end
end
 
 function DS.dropArmor(amount, coord)
    OBJECT.CREATE_AMBIENT_PICKUP(1274757841, coord.x, coord.y, coord.z, 0, amount, 1, false, true);
	print("drop armor");
 end
 function DS.giveAR15(coord)
    OBJECT.CREATE_AMBIENT_PICKUP(273925117, coord.x, coord.y, coord.z, 0, 500, 1, false, true);
	print("Give AR-15");
 end
 function DS.giveGrenade(coord)
    OBJECT.CREATE_AMBIENT_PICKUP(-1491601256, coord.x, coord.y, coord.z, 0, 1, 1, false, true);
	print("Give Grenade");
 end
-- play sound
function DS.playSound()
	--AUDIO.PLAY_SOUND_FRONTEND(-1, "PICK_UP", "HUD_FRONTEND_DEFAULT_SOUNDSET", true);
	--AUDIO.PLAY_SOUND_FRONTEND(-1, "RESUME", "HUD_FRONTEND_DEFAULT_SOUNDSET", true);
	AUDIO.PLAY_SOUND_FRONTEND(-1, "RESUME", "FRONTEND_GAME_PICKUP_AMMOB5", true);
end
function DS.giveReward()
	local level = DS.data["level"];
	if (level == 1) then
		DS.spawnVeh("annihilator");
		--DS.data["reward_vech_name"] = "Akuma Bike";
	elseif(level == 2) then
		DS.spawnVeh("bulldozer");
		--DS.data["reward_vech_name"] = "Bulldozer";
	elseif(level == 3) then
		DS.spawnVeh("rhino");
		--DS.data["reward_vech_name"] = "Tank";
	elseif(level == 4) then
		DS.spawnVeh("akuma");
		--DS.data["reward_vech_name"] = "Annihilator";
	elseif(level == 5) then
		DS.spawnVeh("annihilator");
		--DS.data["reward_vech_name"] = "Annihilator";
	end
end
function DS.teleport_to_coords_before_death()
	local playerPed = PLAYER.PLAYER_PED_ID();
	local coord=ENTITY.GET_ENTITY_COORDS(playerPed, true);
	print("Force:Teleport::location_before:"..coord.x);
	DS.data["location_before_teleport"] = coord;
	local targetlocation = DS.data["last_coords"];
	if(targetlocation.x ~= nil) then
		DS.godOn(3);
		DS.godAddTime(500);
		--print("Teleporting to church: "..RaptureDJ.data["teleport_pointer"]);
		ENTITY.SET_ENTITY_COORDS(playerPed, targetlocation.x, targetlocation.y, targetlocation.z, true, true, true, true);
		return true;
	else 
		return false;
	end
end
function DS.spawnVeh(modelName) 
	local skin = GAMEPLAY.GET_HASH_KEY(modelName);
	local playerPed = PLAYER.PLAYER_PED_ID();
	local coords = ENTITY.GET_OFFSET_FROM_ENTITY_IN_WORLD_COORDS(playerPed, 0.0, 25.0, 2.0);
	STREAMING.REQUEST_MODEL(skin)
	while(not STREAMING.HAS_MODEL_LOADED(skin)) do
		wait(1)
	end
	local v = VEHICLE.CREATE_VEHICLE(skin, coords.x, coords.y, coords.z, ENTITY.GET_ENTITY_HEADING(playerPed), false,false);
	table.insert(DS.data["vehicles"],v);
	STREAMING.SET_MODEL_AS_NO_LONGER_NEEDED(skin);
end
-- draw text on screen
function DS.drawText(text, x, y, scale, center, font, r, g, b)
	UI.SET_TEXT_FONT(font);
	UI.SET_TEXT_SCALE(scale, scale);
	UI.SET_TEXT_COLOUR(r, g, b, 255);
	UI.SET_TEXT_WRAP(0.0, 1.0);
	UI.SET_TEXT_CENTRE(center);
	UI.SET_TEXT_EDGE(2, 255, 255, 255, 205);
	UI._SET_TEXT_ENTRY("STRING");
	UI.SET_TEXT_DROPSHADOW(2, 0, 0, 0, 205);
	UI._ADD_TEXT_COMPONENT_STRING(text);
	UI._DRAW_TEXT(y, x);
end
function DS.displaySpawnTitle(txt,size)
	DS.drawText(txt, 0.3, 0.49, size, true, 1, 255, 0, 0);
end
function DS.setBlip(x,y,z,c,n,f)
	blip=UI.ADD_BLIP_FOR_COORD(x,y,z);
	UI.SET_BLIP_COLOUR(blip, c);
	UI.SET_BLIP_SCALE(blip, 0.9);
	--UI.SET_BLIP_ROUTE(int blip, BOOL enabled);
	--UI.SET_BLIP_SHOW_CONE(blip, false);
	--UI.SET_BLIP_HIGH_DETAIL(blip, true);
	if (n ~= nil and n > 0) then
		UI.SHOW_NUMBER_ON_BLIP(blip, n);
	end
	if (f == true) then
		print("set flashing on");
		UI.SET_BLIP_FLASHES(blip, true);
	else
		UI.SET_BLIP_FLASHES(blip, false);
	end
	table.insert(DS.data["blips"],blip);
	return blip;
end
function DS.removeBlips()
	for i=1, #DS.data["blips"] do
	    local b = DS.data["blips"];
		if (b ~= nil) then
			UI.REMOVE_BLIP(DS.data["blips"][i]);
		end
	end
	DS.data["blips"] = {};
end
function DS.giveLoadout()
	local playerPed = PLAYER.PLAYER_PED_ID();
	local level = DS.data["level"];
	print("Give load out:"..level);
	if (level == 1) then
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_PISTOL"), 2000, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_COMBATPISTOL"), 2000, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_GRENADE"), 3, false);
	elseif(level == 2) then
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_PISTOL"), 2000, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_COMBATPISTOL"), 2000, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_MICROSMG"), 2000, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_SMG"), 2000, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_PROXMINE"), 2000, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_MOLOTOV"), 2000, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_GRENADE"), 3, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_ASSAULTSHOTGUN"), 20, false);
	elseif(level == 3) then
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_PISTOL"), 2000, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_COMBATPISTOL"), 2000, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_CARBINERIFLE"), 500, true);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_ASSAULTSHOTGUN"), 2000, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_PROXMINE"), 2000, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_MOLOTOV"), 2000, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_GRENADE"), 3, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_STICKYBOMB"), 2000, false);
	elseif(level == 4) then
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_PISTOL"), 2000, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_COMBATPISTOL"), 2000, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_CARBINERIFLE"), 500, true);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_ASSAULTSHOTGUN"), 2000, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_PROXMINE"), 2000, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_MOLOTOV"), 2000, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_RPG"), 50, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_MINIGUN"), 2000, false);
	elseif(level >= 5) then
		DS.giveAllWeapons();
	end
end
function DS.giveAllWeapons()
		print("DS::GiveAllWeapons");
		local playerPed = PLAYER.PLAYER_PED_ID();
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_PISTOL"), 2000, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_COMBATPISTOL"), 2000, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_CARBINERIFLE"), 500, true);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_ASSAULTSHOTGUN"), 2000, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_PROXMINE"), 1000, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_MOLOTOV"), 2000, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_RPG"), 1050, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_MINIGUN"), 2000, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_KNIFE"),1, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_HAMMER"), 1, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_GOLFCLUB"), 1, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_MICROSMG"), 2000, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_ASSAULTSMG"), 2000, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_ADVANCEDRIFLE"), 2000, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_COMBATMG"), 2000, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_PUMPSHOTGUN"), 2000, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_SAWNOFFSHOTGUN"), 2000, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_BULLPUPSHOTGUN"), 2000, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_HEAVYSNIPER"), 2000, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_GRENADELAUNCHER"), 2000, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_SMOKEGRENADE"), 2000, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_DAGGER"), 1, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_HATCHET"), 1, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_HEAVYSHOTGUN"), 2000, false);
		WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_MARKSMANRIFLE"), 2000, false);
end
-- Dank related
-- ==================
-- givn skin as cloneTarget, valid coords, returns Dank
function DS.makeDankClone(cloneTarget, coords)
	if(coords ~= nil) then
		DS.playSound();
		skin_hash = GAMEPLAY.GET_HASH_KEY(cloneTarget);
		STREAMING.REQUEST_MODEL(skin_hash)
		while(not STREAMING.HAS_MODEL_LOADED(skin_hash)) do
			wait(1)
		end
		local clone = PED.CREATE_PED(26, GAMEPLAY.GET_HASH_KEY(cloneTarget), coords.x, coords.y, coords.z, 1, false, true);
		local g = GAMEPLAY.GET_HASH_KEY("army");
		PED.SET_PED_AS_GROUP_MEMBER(clone, g);
		PED.SET_PED_RELATIONSHIP_GROUP_HASH(clone, g);
		PED.SET_PED_CAN_SWITCH_WEAPON(clone,true);
		--PED.SET_PED_COMBAT_MOVEMENT(clone, 3);
		PED.SET_PED_ARMOUR(clone, 200);
		PED.SET_PED_CAN_SMASH_GLASS(clone, true, true);
		PED.SET_PED_ALERTNESS(clone, 100);
		PED.SET_PED_SEEING_RANGE(clone, 1000);
		PED.SET_PED_MONEY(clone, 100);
		PED.SET_PED_SHOOT_RATE(clone, 500); -- 1 to 1000
		ENTITY.SET_ENTITY_INVINCIBLE(clone, false);
		ENTITY.SET_ENTITY_HEALTH(clone, 100);
		WEAPON.SET_PED_DROPS_WEAPONS_WHEN_DEAD(clone, true);
		AI.SET_PED_PATH_CAN_USE_CLIMBOVERS(clone, true);
		AI.SET_PED_PATH_CAN_USE_LADDERS(clone, true);
		AI.SET_PED_PATH_CAN_DROP_FROM_HEIGHT(clone, true);
		DS.godOn(5);
		-- WAVE 1
		if(cloneTarget == DS.hell["zombie"]) then
			WEAPON.GIVE_DELAYED_WEAPON_TO_PED(clone, DS.settings["level_weapons_zombie"][DS.data["level"]], 500, true);
			PED.SET_PED_ACCURACY(clone, DS.settings["level_accuracy_zombie"][DS.data["level"]]);
			DS.setBlip(coords.x, coords.y, coords.z, 0, 1, false);
			DS.godAddTime(200);
		-- Wave 2
		elseif (cloneTarget == DS.hell["demon"]) then
			WEAPON.GIVE_DELAYED_WEAPON_TO_PED(clone, DS.settings["level_weapons_demon"][DS.data["level"]], 500, true);
			DS.giveGrenade(coords);
			PED.SET_PED_ACCURACY(clone, DS.settings["level_accuracy_demon"][DS.data["level"]]);
			DS.setBlip(coords.x, coords.y, coords.z, 17, 2, false);
			DS.godAddTime(200);
		-- Wave 3
		elseif (cloneTarget == DS.hell["boss"]) then
			WEAPON.GIVE_DELAYED_WEAPON_TO_PED(clone, DS.settings["level_weapons_boss"][DS.data["level"]], 500, true);
			PED.SET_PED_ACCURACY(clone, DS.settings["level_accuracy_boss"][DS.data["level"]]);
			DS.setBlip(coords.x, coords.y, coords.z, 23, 3, false);
			DS.godAddTime(300);
			DS.giveGrenade(coords);
		end
		--AI.TASK_COMBAT_HATED_TARGETS_AROUND_PED(clone, 5000, 0);
		AI.TASK_COMBAT_PED(clone, PLAYER.PLAYER_PED_ID(), 1 ,1);
		PED.SET_PED_KEEP_TASK(clone, true);
		STREAMING.SET_MODEL_AS_NO_LONGER_NEEDED(skin_hash);
		return clone;
	else
	  --print("coords nil");
	  return 0;
	end
end
-- Dank Spawn Types
-- ==================
--  Spawn a Zombie
function DS.Zombie(coords)
	--print("New Zombie::"..coords.x);
	if (coords.x == 0) then
	 --print("Error: coords.x is 0 creating zombie");
	else
		local d = DS.makeDankClone(DS.hell["zombie"], coords);
		table.insert(DS.data["zombies"],d);
		return d;
	end
	return 0;
end
--  Spawn a Demon
function DS.Demon(coords)
	--print("New Demon::"..coords.x);
	if (coords.x == 0) then
		--print("Error: coords.x is 0 creating demon");
	else
		local d = DS.makeDankClone(DS.hell["demon"], coords);
		table.insert(DS.data["demons"],d);
		return d;
	end
	return 0;
end
-- Spawn a Boss
function DS.Boss(coords)
	--print("New Boss::"..coords.x);
	if (coords.x == 0) then
		--print("Error: coords.x is 0 creating boss");
	else
		local d = DS.makeDankClone(DS.hell["boss"], coords);
		table.insert(DS.data["bosses"],d);
		return d;
	end
	return 0;
end
-- Dank Game Management
-- ======================
-- keep track of unique peds (seenPeds) table
function DS.raiseTheDoomed()
	local playerPed = PLAYER.PLAYER_PED_ID();
	local PedTab,PedCount = PED.GET_PED_NEARBY_PEDS(playerPed, 1, 1);
	for k,thisPed in ipairs(PedTab)do
		if(thisPed == playerPed)then
		else
			if (DS.isNewPed(thisPed)) then
				local skin =  ENTITY.GET_ENTITY_MODEL(thisPed);
				table.insert(DS.data["seenPeds"],thisPed);
				table.insert(DS.data["seenPedSkins"],skin);
			end
		end
	end
end
function DS.isNewPed(ped)
	for i=1,#DS.data["seenPeds"] do
		if(DS.data["seenPeds"][i] == ped) then
			return false;
		end
	end
	return true;
end
-- have any known peds died?
function DS.checkSeen()
	for i=1,#DS.data["seenPeds"] do
		-- grab the next ped
		local thisPed = DS.data["seenPeds"][i];
		-- make sure not deleted
		if (thisPed ~= nil) then
			-- check if this ped is dead
			local dead = ENTITY.IS_ENTITY_DEAD(thisPed);
			-- if ped is dead, and we have a valid skin to parse
			if(dead) then
				-- we stored the skin before, let's get it
				local thisPedSkin = DS.data["seenPedSkins"][i];
				if (thisPedSkin) then
					-- generate clone from hell
					DS.spawnDank(thisPed, thisPedSkin, i);
				end
			end
		end
	end
end
-- 
function DS.spawnDank(thisPed, skinhash, i)
	-- get ped's location so we can turn it undead
	local coord = ENTITY.GET_ENTITY_COORDS(thisPed, false);
	local undead = 0;
	-- sometimes the timing of reading a ped and when one is deleted/readable
	-- produces nil / empty values. here we filter them to avoid crashing the game
	if (coord.x == 0) then
		--print("ERROR: spawnDank coord is 0 PED:"..thisPed);
	else
		-- data is good, now let's filter dead ped by skin
		-- dead chicken!
		if (skinhash == DS.data["skinhash_chicken"]) then
			--print("you killed the chicken!");
			DS.data["chicken_in_play"]= false;
			DS.data["chicken"] = nil;
			DS.toggle["chicken_is_loose"] =  false;
			DS.data["game_scanner"] = false;
			print("Chicken Killed, give health");
			DS.giveHealth(100, coord);
			local rtotal = 0;
			if(DS.timer["chicken"] > 0) then
				-- if timer is still running, give a bouns based on time left
				local temp = 0;
				-- over 4000
				if (DS.timer["chicken"] > 4000) then
					DS.timer["chicken"] = 4000;
				    temp = DS.timer["chicken"] / 400; 
				-- 2000 to 4000 ()
				elseif(DS.timer["chicken"] > 2000 and DS.timer["chicken"] < 4000) then
					temp = DS.timer["chicken"] / 400;
				elseif(DS.timer["chicken"] > 500 and DS.timer["chicken"] < 2000) then
				    temp = DS.timer["chicken"] / 100;	
				-- 100 to 500 ()
				elseif(DS.timer["chicken"] > 100 and DS.timer["chicken"] < 500) then
					temp = DS.timer["chicken"] / 100;
				else
					temp = DS.timer["chicken"] / 2;
				end
				--print("GIVE TIME BONUS:"..temp);
				for i=1,temp do 
					DS.giveMoney(10);
					DS.playSound();
					DS.giveGrenade(coord);
					rtotal = rtotal * 10;
					DS.drawText("$"..rtotal, 0.4, 0.4, 2.0, false, 0, 255, 255, 255);
					wait(110);
				end
				print("Done giving bounus");
				local bonus = math.floor(DS.data["chicken_total"] * 100);
				DS.giveMoney(bonus);
				
			end	
		-- dead zombie found, create a demon replacement
		elseif (skinhash == DS.data["skinhash_zombie"]) then
			print(thisPed, "Zombie dead found, create demon");
			undead = DS.Demon(coord);
		-- dead demon found, create a boss
		elseif (DS.data["wave_progression"] and skinhash == DS.data["skinhash_demon"]) then
			print(thisPed, "Demon dead found, create boss");
			undead = DS.Boss(coord);
		-- dead boss found, end of round!
		elseif (DS.data["wave_progression"] and skinhash == DS.data["skinhash_boss"]) then
			print(thisPed, "Boss dead found");
			--undead = DS.Zombie(coord);
			-- give health to player
			DS.giveHealth(100, coord);
			DS.giveMoney(100);
			DS.dropArmor(50, coord);
			table.insert(DS.data["finished_wave"],thisPed);
		-- dead ped found, create zombie
		else
			print(thisPed, "Skin hash unknown, Ped was killed", skinhash);
			undead = DS.Zombie(coord);
		end
		DS.levelCheck();
		-- make sure players have enough health packs around when 
		-- not using as resource flask.
		if(not DS.settings["health_as_a_resource"]) then
			DS.giveHealth(100, coord);
		end
		-- remove the original ped (human) from the seenPed list
		-- as they are now Dank
		PED.DELETE_PED(thisPed);
		DS.data["seenPeds"][i] = nil;
		DS.data["seenPedSkins"][i] = nil;
	end
end
function DS.levelCheck()
	--DS.waveTick();
	-- using the number of completed waves (ped to boss)
	-- let us calculate the current difficulty level
	-- ==================================================
	local f = #DS.data["finished_wave"];-- how many waves of undead did we kill?
	print("chklvl finished waves:"..f);
	local done = false;
	local before = DS.data["level"]; -- current level before our test
	if (f <= DS.settings["level_1_finished_waves"]) then
		DS.data["level"] = 1;
		done = true;
	elseif (not done and f <= DS.settings["level_2_finished_waves"]) then
		DS.data["level"] = 2;
		DS.data["finished_level"] = 1;
		done = true;
	elseif (not done and f <= DS.settings["level_3_finished_waves"]) then
		DS.data["level"] = 3;
		DS.data["finished_level"] = 2;
		done = true;
	elseif (not done and f <= DS.settings["level_4_finished_waves"]) then
		DS.data["level"] = 4;
		DS.data["finished_level"] = 3;
		done = true;
	elseif (not done and f > DS.settings["level_5_finished_waves"]) then
		DS.data["level"] = 5;
		DS.data["finished_level"] = 4;
		done = true;
	elseif (not done and f > DS.settings["level_6_game_overtime"]) then
		DS.data["level"] = 5;
		DS.data["finished_level"] = 4;
		DS.data["bounus_round"] = true;
		done = true;
	end
	-- Increase level during chicken game
	if(DS.data["chicken_total"] == 5) then
		DS.data["level"] = 2;
		DS.data["finished_level"] = 1;
	elseif(DS.data["chicken_total"] ==10) then
		DS.data["level"] = 3;
		DS.data["finished_level"] = 2;
	elseif(DS.data["chicken_total"] ==15) then
		DS.data["level"] = 4;
		DS.data["finished_level"] = 3;
	elseif(DS.data["chicken_total"] ==25) then
		DS.data["level"] = 5;
		DS.data["finished_level"] = 4;
	end
	-- let's check if the player made a new level
	if (DS.data["level"] > before) then
		-- new level achieved!
		DS.toggle["new_level_reached"] = true;
		DS.giveMoney(1500);
		print("new level!");
		DS.data["reward_earned"] = true;
		DS.data["reward_not_claimed"] = true;
	end
	-- reset the death check delay
	DS.settings["deathCheckDelay"]  = DS.settings["level_deathCheckDelay"][DS.data["level"]];
end
function DS.spawnChicken()
	local chkCorrds = DS.settings["level_chicken_spawn_distance"][DS.data["level"]];
	print("Chick coords:"..chkCorrds);
	local playerPed = PLAYER.PLAYER_PED_ID();
	local coords;
	if(DS.data["level"] == 1) then
		coords = ENTITY.GET_OFFSET_FROM_ENTITY_IN_WORLD_COORDS(playerPed, 0.0, 10.0, 1.0);
	elseif(DS.data["level"] == 2) then
		coords = ENTITY.GET_OFFSET_FROM_ENTITY_IN_WORLD_COORDS(playerPed, 0.0, 15.0, 1.0);
	elseif(DS.data["level"] == 3) then
		coords = ENTITY.GET_OFFSET_FROM_ENTITY_IN_WORLD_COORDS(playerPed, 0.0, 20.0, 1.0);
	elseif(DS.data["level"] == 4) then
		coords = ENTITY.GET_OFFSET_FROM_ENTITY_IN_WORLD_COORDS(playerPed, 0.0, 25.0, 1.0);	
	end
	DS.spawnChickenAtLocation(coords);
end			
function DS.spawnChickenAtLocation(coord)
	if (DS.data["chicken"] == nil or DS.data["chicken"] == 0) then
		local skin_hash = GAMEPLAY.GET_HASH_KEY(DS.hell["chicken"]);
		local dz= coord.z + 2;
		local dy = coord.y + 2;
		STREAMING.REQUEST_MODEL(skin_hash);
		while(not STREAMING.HAS_MODEL_LOADED(skin_hash)) do
			wait(1);
		end
		local clone = PED.CREATE_PED(26, skin_hash, coord.x, dy, dz, 1, false, true)
		local g = GAMEPLAY.GET_HASH_KEY("army");
		PED.SET_PED_AS_GROUP_MEMBER(clone, g);
		PED.SET_PED_RELATIONSHIP_GROUP_HASH(clone, g);
		ENTITY.SET_ENTITY_INVINCIBLE(clone, false);
		PED.SET_PED_MONEY(clone, 5000);
		PED.SET_PED_ARMOUR(clone, 200);
		DS.data["chicken_timer_up"] = false;
		DS.timer["chicken"] = 5000;
		DS.toggle["chicken_is_loose"] = true;
		--ENTITY.FREEZE_ENTITY_POSITION(clone, true);
		if(clone == 0) then
			print("DS::spawnChicken::error found");
		end
		DS.data["chicken"] = clone;
		--STREAMING.SET_MODEL_AS_NO_LONGER_NEEDED(skin_hash);
		DS.data["chicken_in_play"] = true;
		print("DS::spawnChicken::chicken total::"..DS.data["chicken_total"]);
		
		if(DS.data["chicken_total"] == 0) then
			DS.data["chicken_zombies"] = DS.data["chicken_zombies"] + 1;
			DS.playSound();
			DS.Zombie(coord);
			print("DS::spawnChicken::single zombie created:"..DS.data["chicken"]);
		elseif(DS.data["chicken_total"] > 0) then	
			local dx = 0.5;
			local yx = 0.5;
			for i=0, DS.data["chicken_total"] do
				dx = dx + -2.5 * i;
				dy = dy + 5.5 * i;
				if(dx > 10.0) then
					dx = 0.5;
				end
				if(dy > 10.0) then
					dy = 0.5;
				end
				
				print("chicken zombie coords:"..dx.." yx:"..yx);
				local coords = ENTITY.GET_OFFSET_FROM_ENTITY_IN_WORLD_COORDS(clone, yx, dx, 1.0);
				DS.data["chicken_zombies"] = DS.data["chicken_zombies"] + 1;
				DS.playSound();
				DS.Zombie(coords);
				
				print("DS::spawnChicken::multiple zombie:"..i.." created:"..DS.data["chicken"]);
			end
		end	
	else
		print("DS::spawnChicken::Chicken already in play:"..DS.data["chicken"]);
	end
end
-- Clear game of Dank
function DS.killEmAll()
	DS.removeBlips();
	print("Kill em all");
	print("Seenpeds:"..#DS.data["seenPeds"]);
	for i=1, #DS.data["seenPeds"] do
		local thisPed = DS.data["seenPeds"][i];
		if(thisPed ~= nil)then
			DS.data["seenPeds"][i] = nil;
			DS.data["seenPedSkins"][i] = nil;
			PED.DELETE_PED(thisPed);
		end
	end
	print("Zombies:"..#DS.data["zombies"]);
	for i=1, #DS.data["zombies"] do
		if(thisPed ~= nil)then
			local thisPed = DS.data["zombies"][i];
			DS.data["zombies"][i] = nil;
			PED.DELETE_PED(thisPed);
		end
	end
	print("demons:"..#DS.data["demons"]);
	for i=1, #DS.data["demons"] do
		if(thisPed ~= nil)then
			local thisPed = DS.data["demons"][i];
			DS.data["demons"][i] = nil;
			PED.DELETE_PED(thisPed);
		end
	end
	print("bosses:"..#DS.data["bosses"]);
	for i=1, #DS.data["bosses"] do
		if(thisPed ~= nil)then
			local thisPed = DS.data["bosses"][i];
			DS.data["bosses"][i] = nil;
			PED.DELETE_PED(thisPed);
		end
	end
	if(DS.data["chicken"] ~= nil) then
		PED.DELETE_PED(DS.data["chicken"]);
		DS.data["chicken_in_play"] = false;
		DS.data["chicken"] = nil;
	end
	if(DS.data["vehicles"] ~= nil) then
		for i=1, #DS.data["vehicles"] do
			local thisCar = DS.data["vehicles"][i];
			VEHICLE.DELETE_VEHICLE(thisCar);
			print("deleting veh:"..thisCar);
		end
	end
end
-- ====================================================================
-- update blips on map for all Dank peds
--  Type     Number     color
--  Zombie     1        white
--  Demon      2        orange
--  Boss       3        pink
--
--  Alive peds show number of their group
--  Dead peds show clear icon, no number. (They will spawn next wave)
-- ====================================================================
function DS.updateBlipsForDank()
	DS.removeBlips();
	local t_active = 0; -- count the number of active Dank
	local t_chicken_active_count = 0;
	--print("update blips zombies:"..#DS.data["zombies"]);
	for i=1,#DS.data["zombies"] do
		local thisPed = DS.data["zombies"][i];
		 local dead = ENTITY.IS_ENTITY_DEAD(thisPed);
		 local health = ENTITY.GET_ENTITY_HEALTH(thisPed);
		if (thisPed ~= nil) then
			local coord = ENTITY.GET_ENTITY_COORDS(thisPed, false);
			if (coord.x == 0)then
				DS.data["bad_coords"] = DS.data["bad_coords"] + 1;
			else
				t_active = t_active + 1; -- count dead or alive
				if (dead) then
					DS.setBlip(coord.x,coord.y,coord.z,0,0);
				else
					--print("Zombie health:"..health);
					if (health ~= nil and health < 100) then
						DS.setBlip(coord.x,coord.y,coord.z,0,1, true);
					else
						t_chicken_active_count = t_chicken_active_count + 1;
						DS.setBlip(coord.x,coord.y,coord.z,0,1, false);
					end
				end
			end
		end
	end
	--print("update blips demons:"..#DS.data["demons"]);
	for i=1,#DS.data["demons"] do
		local thisPed = DS.data["demons"][i];
		 local dead = ENTITY.IS_ENTITY_DEAD(thisPed);
		  local health = ENTITY.GET_ENTITY_HEALTH(thisPed);
		if (thisPed ~= nil) then
			local coord = ENTITY.GET_ENTITY_COORDS(thisPed, false);
			if (coord.x == 0)then
				DS.data["bad_coords"] = DS.data["bad_coords"] + 1;
			else
				t_active = t_active + 1;
				if (dead) then
					DS.setBlip(coord.x,coord.y,coord.z,17,0);
				else
				--print("Demon health:"..health);
				if (health ~= nil and health < 100) then
						DS.setBlip(coord.x,coord.y,coord.z,17,2, true);
					else
						t_chicken_active_count = t_chicken_active_count + 1;
						DS.setBlip(coord.x,coord.y,coord.z,17,2, false);
					end
				end
			end
		end
	end
	--print("update blips bosses:"..#DS.data["bosses"]);
	for i=1,#DS.data["bosses"] do
		local thisPed = DS.data["bosses"][i];
		 local dead = ENTITY.IS_ENTITY_DEAD(thisPed);
		  local health = ENTITY.GET_ENTITY_HEALTH(thisPed);
		if (thisPed ~= nil) then
			local coord = ENTITY.GET_ENTITY_COORDS(thisPed, false);
			if (coord.x == 0)then
				DS.data["bad_coords"] = DS.data["bad_coords"] + 1;
			else
				if (dead) then
					DS.setBlip(coord.x,coord.y,coord.z,23,0);
				else
					--print("bosses health:"..health);
					t_active = t_active + 1; 
					if (health ~= nil and health < 100) then
						DS.setBlip(coord.x,coord.y,coord.z,23,3, true);
					else
						t_chicken_active_count = t_chicken_active_count + 1;
						DS.setBlip(coord.x,coord.y,coord.z,23,3, false);
					end
				end
			end
		end
	end
	if(DS.data["chicken_in_play"]) then
		local thisPed = DS.data["chicken"];
		 local dead = ENTITY.IS_ENTITY_DEAD(thisPed);
		  local health = ENTITY.GET_ENTITY_HEALTH(thisPed);
		if (thisPed ~= nil) then
			local coord = ENTITY.GET_ENTITY_COORDS(thisPed, false);
			if (coord.x == 0)then
				DS.data["bad_coords"] = DS.data["bad_coords"] + 1;
			else
				if (dead) then
					DS.setBlip(coord.x,coord.y,coord.z,21,0);
					DS.timer["deathCheck"] = 0; -- stop the scanner and total dead now
					DS.data["chicken_total"] = DS.data["chicken_total"] + 1;
					-- first two levels Danks die when chicken does
					if (DS.data["level"] < 3) then
						DS.killEmAll();
					end
				else
					t_active = t_active + 1; 
					if (health ~= nil and health < 100) then
						DS.setBlip(coord.x,coord.y,coord.z,21,6, true);
					else
						DS.setBlip(coord.x,coord.y,coord.z,21,6, false);
					end
				end
			end
		end
	end
	DS.data["chicken_active_enemy_count"] = t_chicken_active_count;
	-- how many Danks is the player fighting at once?
	if (t_active > DS.data["max_num_Dank"] ) then
		DS.data["max_num_Dank"] = t_active;
	end
	if (t_active > 0) then
		DS.data["active_threat"] = "";
	else 
		DS.data["active_threat"] = "";
	end
	DS.data["chicken_active_enemy_count"] = t_active;
end
function DS.godOff()
	local player = PLAYER.PLAYER_ID()
	local playerPed = PLAYER.PLAYER_PED_ID()
	ENTITY.SET_ENTITY_INVINCIBLE(playerPed, false);
	DS.settings["invincible"] = false;
	print("DS::godOff::turning player invincibility off");
	DS.timer["godmode"] = 0;
	DS.toggle["godmode"]=false;
end
function DS.godOn(time_)
	local player = PLAYER.PLAYER_ID()
	local playerPed = PLAYER.PLAYER_PED_ID()
	ENTITY.SET_ENTITY_INVINCIBLE(playerPed, true);
	DS.settings["invincible"] = true;
	print("DS::godOn::turning player invincibility on");
	DS.timer["godmode"] = time_;
	DS.toggle["godmode"]=true;
end
function DS.godAddTime(time_)
	print("DS::godAddTime::"..time_);
	DS.timer["godmode"] = DS.timer["godmode"] + time_; 
end
function DS.getScore()
	local z = #DS.data["zombies"];
	local d = #DS.data["demons"];
	local b = #DS.data["bosses"];
	local f = #DS.data["finished_wave"];
	local p = #DS.data["seenPeds"];
	local total_z = z * DS.settings["score_zombie"];
	local total_d = d * DS.settings["score_demon"];
	local total_b = b * DS.settings["score_boss"];
	local total_hell_kills = f * 1; -- one for each Dank wave (sinner, zombie, demon, boss)
	--total_hell_kills = total_hell_kills * RaptureDJ.settings["score_bonus_total_kills"];
	local score = total_z + total_d + total_b + total_hell_kills;
	--print("zombies:"..total_z.." Demons:"..total_d.." Bosses:"..total_b.." Bonus kills:"..total_hell_kills.."\nScore:"..score);
	DS.data["score"] = score;
end
function DS.setupGame()
	print("Dank Souls v"..DS.data["version"].." - Welcome to your doom");
	-- let's initialize the wave counter delay (how long between Dank spawns) setting to the current level
	DS.settings["deathCheckDelay"]  = DS.settings["level_deathCheckDelay"][DS.data["level"]];
	DS.settings["dialog_cooldown"] = 750;
	DS.settings["spawn_cooldown"] = 550;
	DS.data["zombies"] = {};
	DS.data["demons"] = {};
	DS.data["bosses"] = {};
	DS.data["score"] = 0;
	DS.data["level"] = 1;
	DS.data["blips"] = {};
	DS.data["bad_coords"] = 0;
	DS.data["skinhash_zombie"] = "nil";
	DS.data["skinhash_demon"] =  "nil";
	DS.data["skinhash_boss"] =  "nil";
	DS.data["skinhash_chicken"] =  "nil";
	DS.data["chicken"] = nil;
	DS.data["chicken_in_play"] = false;
	DS.timer["blip"] = DS.settings["blip_update_delay"];
	DS.timer["new_level_reached"] = 0;
	DS.data["deaths"] = 0;
	DS.data["death"] = false;
	DS.data["game_over"] = false;
	DS.data["last_coords"] = {};
	DS.data["last_coords"].x = 0;
	DS.data["last_coords"].y = 0;
	DS.data["last_coords"].z = 0;
	--DS.toggle["new_level_reached"] = false;
	DS.data["chicken_active_enemy_count"] = 0;
	DS.data["skinhash_zombie"] = GAMEPLAY.GET_HASH_KEY(DS.hell["zombie"]);
	print(DS.data["skinhash_zombie"], "Skinhash zombie");
	DS.data["skinhash_demon"] = GAMEPLAY.GET_HASH_KEY(DS.hell["demon"]);
	print(DS.data["skinhash_demon"], "Skinhash demon");
	DS.data["skinhash_boss"] = GAMEPLAY.GET_HASH_KEY(DS.hell["boss"]);
	print(DS.data["skinhash_boss"], "Skinhash boss");
	DS.data["skinhash_chicken"] = GAMEPLAY.GET_HASH_KEY(DS.hell["chicken"]);
	print(DS.data["skinhash_chicken"], "Skinhash chicken");
	DS.timer["pedCheck"] = DS.settings["pedCheckDelay"];
	DS.data["setup"] = true;
	DS.data["reward_earned"] = true;
	DS.data["reward_not_claimed"] = true;
	DS.toggle["game_scanner"] = true;
	DS.data["chicken_zombies"] = 0;
	DS.data["max_num_Dank"] = 0;
	DS.data["deaths"] = 0;
	DS.data["lives"] = 0;
	DS.settings["game_mode"] = 0;
	DS.data["chicken_timer_up"] = false;
	DS.data["chicken_total"] = 0;
	DS.timer["chicken"] = 5000;
end
function DS.startkey_action_handler()
	print("del key press");
	if (DS.data["playGame"]) then
		DS.data["playGame"] = false;
		print("playGame now false");
		DS.removeBlips();
		DS.killEmAll();
		DS.setupGame();
		DS.toggle["spawn_dialog"] = false;
		DS.data["game_over"] = false;
		DS.data["setup"] = false;
	else
		DS.data["playGame"] = true;
		print("playGame now true");
		--CAM.DO_SCREEN_FADE_OUT(50);
		DS.removeBlips();
--		DS.killEmAll();
		DS.setupGame();
		DS.toggle["spawn_dialog"] = true;
		DS.timer["spawn_timer"] = 200;
		DS.data["game_over"] = false;
		DS.godOn(200); 
		DS.settings["game_mode"] = 0;
		DS.data["show_help"] =  false;
	end
end
-- Update
-- ==================
function DS.tick()
	local player = PLAYER.PLAYER_ID()        -- The players 'identity' as a Player type
	local playerPed = PLAYER.PLAYER_PED_ID() -- returns the playing Ped
	local deathcheck = PLAYER.IS_PLAYER_DEAD(player)
	local r_= 255;
	local g_= 255;
	local b_= 255;
	PLAYER._SET_MOVE_SPEED_MULTIPLIER(playerPed, 20.25);
	ENTITY.SET_ENTITY_MAX_SPEED(player, 200.0);
	--local coords = ENTITY.GET_ENTITY_FORWARD_VECTOR(PLAYER.PLAYER_PED_ID());
	--local fx = ENTITY.GET_ENTITY_FORWARD_X(PLAYER.PLAYER_PED_ID());
	--local fy = ENTITY.GET_ENTITY_FORWARD_Y(PLAYER.PLAYER_PED_ID());
	-- make sure we are in correct position and player init is complete
	if (not DS.data["setup"]) then
		DS.setupGame();
	end
	if(get_key_pressed(33)) then -- pageUp
		CAM.DO_SCREEN_FADE_IN(1);
	end
	if(get_key_pressed(46)) then --  del (start)
		DS.startkey_action_handler();
		wait(1000);
	end
	if(DS.data["final_kills"] == nil) then 
		DS.data["final_kills"] = 0;
	end
	-- CP: Game over hud
	-- ==================
	if (DS.data["game_over"]) then
		ENTITY.FREEZE_ENTITY_POSITION(PLAYER.PLAYER_PED_ID() , true);
		DS.drawText("GAME OVER",  0.1, 0.49, 3.0, true, 1, 0, 0, 0);
		if(DS.settings["game_mode"] == 3)  then
			DS.data["final_kills"] = DS.data["chicken_total"];
			DS.drawText("Chickens:          "..DS.data["chicken_total"], 0.34, 0.49, 2.0, true, 1, 255, 0, 0);
			DS.drawText("Deaths:          "..DS.data["total_deaths"], 0.46, 0.49, 2.0, true, 1, 255, 0, 0);
			DS.drawText("Score:          "..DS.data["final_score"], 0.57, 0.49, 2.0, true, 1, 255, 0, 0);
			--DS.displayCenteredTextGO("Game Over!\nChickens:"..DS.data["chicken_total"].."\nKills:"..DS.data["final_kills"].."\nScore:"..DS.data["final_score"].."\n Del to start a new game", 1.5);
		else
			DS.data["final_kills"] = (#DS.data["finished_wave"]*4);
			DS.drawText("Kills:          "..DS.data["final_kills"], 0.34, 0.49, 2.0, true, 1, 255, 0, 0);
			DS.drawText("Deaths:          "..(DS.data["total_deaths"]-1), 0.46, 0.49, 2.0, true, 1, 255, 0, 0);
			DS.drawText("Score:          "..DS.data["final_score"],0.57, 0.49, 2.0, true, 1, 255, 0, 0);
			DS.drawText(" Note: Kills only count for completed waves.", 0.79, 0.49, 0.26, true, 0, 255, 0, 0);
			--DS.displayCenteredTextGO("Game Over!\nWAVES:"..DS.data["final_waves"].."\nKills:"..DS.data["final_kills"].."\nScore:"..DS.data["final_score"].."\n Del to start a new game", 1.5);
		end
		DS.drawText(" [del] to continue...", 0.74, 0.49, 0.26, true, 0, 255, 255, 0);
		DS.killEmAll();
	end
	local tip = "";
	-- CP: Play Game
	-- ==============
	if(not DS.data["playGame"]) then
		DS.drawText(" [del] Dank Souls rip:"..DS.data["version"], 0.80, 0.0005, 0.24, false, 0,  255, 0, 0);
		ENTITY.FREEZE_ENTITY_POSITION(PLAYER.PLAYER_PED_ID() , false);
		DS.data["level"] = 1;
	else
		DS.drawText(" [del] off - *Dank Souls*", 0.80, 0.0005, 0.24, false, 0,  0, 0, 0);
	-- START
	-- ==================	
		-- check if player is dead
		-- ========================
		if(deathcheck == true)then
			-- mark this state in global
			DS.data["death"]= true;
			local coords_ = ENTITY.GET_ENTITY_COORDS(PLAYER.PLAYER_PED_ID(), false);
			DS.data["last_coords"] = coords_;
			print("Player death detected, saving coords:"..coords_.x);
			tip = DS.showTip();
		end
		-- let's sit here until player is no longer dead
		-- ==============================================
		while (ENTITY.IS_ENTITY_DEAD(PLAYER.PLAYER_PED_ID())) do
			wait(0);
			DS.data["death"]= true;
			DS.drawText("YOU DIED BEOTCH!", 0.14, 0.49, 2.9, true, 1, 255, 0, 0);
			-- TODO:protect out of bounds
			DS.drawText(tip, 0.8, 0.49, 0.6, true, 1, 255, 255, 0);
			deathDetails = PED.GET_PED_CAUSE_OF_DEATH(playerPed);
		end
		-- test if player exists (and is not dead)
		-- =========================================
		local playerExists = ENTITY.DOES_ENTITY_EXIST(playerPed);
		if(playerExists and not deathcheck) then
			-- now that we know the player is in game, let's check if we were dead
			if (DS.data["death"]) then
				--print("TICK::Previous death found!");
				DS.data["death"] = false;
				--DS.resetSpawn();
				DS.toggle["spawn_dialog"] = true;
				DS.timer["spawn_timer"] = 200;
				DS.godOn(100);
				DS.data["deaths"] = DS.data["deaths"] + 1;
				--print(deathDetails);
				if(DS.settings["game_mode"] == 2) then
					--print("TICK::game mode 2, checking death..");
					DS.data["total_deaths"] = DS.data["total_deaths"] + 1;
					DS.data["lives"] = DS.data["lives"] - 1;
					if (DS.data["lives"] == 0) then
						--DS.data["game_over"]= true;
						--print("DS::TICK::out of lives");
						-- call game over when game mode is hardcore
						DS.gameover();
					else
						--print("TICK::lives greater than 0");
					end
					
				else
					--print("TICK:: Skip Death check, not game mode 2::"..DS.settings["game_mode"]);
				end
			end
			-- set last bloodstain (location of death)
			-- =======================================
			local lc = DS.data["last_coords"];
			if (lc.z ~= nil) then
				if(lc.z > 0) then
					DS.drawText(" [L] Last Bloodstain", 0.73, 0.0005, 0.37, false, 1, 255, 255, 0);
				end
			end
			
			-- get rid of the cops, (boring IMO)
			-- =================================
			if(DS.settings["cops_ignore"]) then
				 PLAYER.SET_MAX_WANTED_LEVEL(0);
				 PLAYER.CLEAR_PLAYER_WANTED_LEVEL(playerPed);
			else
				PLAYER.SET_MAX_WANTED_LEVEL(5);
			end
			
			
			-- CP: Game Mode
			-- ==============
			if(DS.settings["game_mode"] == 0) then
				--print("TICK::user_game_mode is nil");
				DS.toggle["game_scanner"]=false;
				--DS.data["total_deaths"]=1;
				DS.data["tip_pointer"] = 0;
				DS.settings["invincible"] = true;
				
				if(not DS.data["show_help"]) then
					-- select game mode screen
					-- ========================
					DS.drawText("DANK SOULS",  0.1, 0.49, 3.0, true, 1, 0, 0, 0);
					DS.drawText("Rip:"..DS.data["version"], 0.21, 0.68, 0.3, false, 1, 255, 255, 255);
					DS.drawText("by CoreLogic 2015", 0.24, 0.35, 0.5, false, 1, 255, 255, 255);
					DS.drawText("[h]elp", 0.24, 0.63, 0.5, false, 1, 255, 255, 255);
					DS.drawText("How do you want to die?", 0.34, 0.49, 1.0, true, 1, 0, 0, 0);
					DS.drawText("[1] Mayhem\n[2] HardCore 3 Lives.\n[3] Eat Every F@$king Chicken.", 0.45, 0.49, 1.0, true, 1, 255, 0, 0);
				else
					-- help screen
					-- ============
					-- center title and controls
					DS.drawText("DANK SOULS",  0.1, 0.49, 3.0, true, 1, 0, 0, 0);
					DS.drawText("Rip:"..DS.data["version"], 0.21, 0.68, 0.3, false, 1, 255, 255, 255);
					DS.drawText("by CoreLogic 2015", 0.24, 0.35, 0.5, false, 1, 255, 255, 255);
					DS.drawText("[h] back", 0.24, 0.63, 0.5, false, 1, 255, 255, 255);
					-- center column, game modes
					DS.drawText("1. Mayhem (Normal):", 0.32, 0.29, 1.0, false, 1, 255, 0, 0);
					DS.drawText("Every time a ped dies, I get three tries to kill you as a wave of Dank Souls.", 0.39, 0.29, 0.5, false, 0, 0, 0, 0);
					DS.drawText("You get unlimited lives, and each Dank will drop pick-ups to help you keep going.", 0.43, 0.29, 0.5, false, 0, 0, 0, 0);
					DS.drawText("2. HardCore:", 0.48, 0.29, 1.0, false, 1, 255, 0, 0);
					DS.drawText("Think you're hard? OK, you only get 3 lives, start some mayhem and make a new high score.", 0.54, 0.29, 0.5, false, 0, 0, 0, 0);
					DS.drawText("3. Eat Every F@$king Chicken!:", 0.61, 0.29, 1.0, false, 1, 255, 0, 0);
					DS.drawText("A Dank Chicken will spawn near you. She will keep spawning Danks.", 0.68, 0.29, 0.5, false, 0, 0, 0, 0);
					DS.drawText("Manage the building hoard and kill each chicken before the timer runs out.", 0.72, 0.29, 0.5, false, 0,  0, 0, 0);
					DS.drawText("First two levels all spawned Danks will die when you kill the chicken.", 0.76, 0.29, 0.5, false, 0,  0, 0, 0);
					DS.drawText("How many chickens can you kill?", 0.80, 0.29, 0.5, false, 0, 0, 0, 0);
					-- left column
					DS.drawText(" The Dark Souls of GTA V", 0.08, 0.00005, 0.65, false, 1, 255, 255, 255);
					DS.drawText(" Volume I: Consequences", 0.12, 0.00005, 0.45, false, 1, 255, 255, 255);
					DS.drawText(" - Each kill you make now has consequences.\n  Each dead ped will spawn a Dank Soul Wave!", 0.15, 0.00005, 0.29, false, 0, 0, 0, 0);
					DS.drawText(" - When the Spawn counter reaches zero it is\n  my turn, Dank Souls will rise.", 0.20, 0.00005, 0.29, false, 0, 0, 0, 0);
					DS.drawText(" - Reach the boss of each wave of three and kill him\n  for needed health, armor and rocket ammo.", 0.25, 0.00005, 0.29, false, 0, 0, 0, 0);
					DS.drawText(" - No cops, good loadout, Danks get smarter and more\n  accurate with each new level.", 0.30, 0.00005, 0.29, false, 0, 0, 0, 0);
					DS.drawText(" - Use 'L' after respawn to retun to your last bloodstain\n  and keep the fight going.", 0.35, 0.00005, 0.29, false, 0, 0, 0, 0);
					DS.drawText(" * Dank blips on mini-map will show numbers when alive\n  and solid when dead.", 0.40, 0.00005, 0.29, false, 0, 0, 0, 0);
					DS.drawText(" * You get some invincibility time for each new Dank\n  be aggressive, use this time to your advantage.", 0.45, 0.00005, 0.29, false, 0, 0, 0, 0);
					DS.drawText(" * The HUD turns red when you need health!", 0.51, 0.00005, 0.29, false, 0, 0, 0, 0);
					-- left column enemy map
					DS.drawText(" Know Thy Enemy Wave:", 0.60, 0.00005, 0.6, false, 1, 255, 0, 0);
					DS.drawText(" - First  Zombie      - white  blip #1", 0.64, 0.00005, 0.36, false, 0, 255, 255, 255);
					DS.drawText(" - Second Demon - orange blip #2", 0.67, 0.00005, 0.36, false, 0, 255, 165, 0);
					DS.drawText(" - Third  Boss         - pink   blip #3", 0.70, 0.00005, 0.36, false, 0, 255, 20, 147);
					DS.drawText(" - Chicken             - brown   blip #6", 0.73, 0.00005, 0.36, false, 0, 139, 69, 19);
				end
			else
				ENTITY.FREEZE_ENTITY_POSITION(PLAYER.PLAYER_PED_ID() , false);
				--print("TICK::user_game_mode is not nil");
				if(not DS.data["game_over"]) then
					DS.toggle["game_scanner"]=true;
				else
					DS.toggle["game_scanner"]=false;
				end
				-- spawn msg
				-- ==================
				if(DS.toggle["spawn_dialog"]) then
					if (DS.timer["spawn_timer"] > 0)  then
						local gm = DS.settings["game_mode"];
						local lbl = "nil";
						if(gm == 1) then
							lbl = "Mayhem\nJust DO IT!\n";
							DS.data["lives"] = 0;
						end
						if(gm == 2) then
							if (DS.data["lives"] == 3) then
								lbl = "HardCore\n you have "..DS.data["lives"].." lives.";
							elseif (DS.data["lives"] == 1) then
								lbl = "HardCore\n this is your last life\nmake it count!";
							else
								lbl = "HardCore\n you have "..DS.data["lives"].." lives left.";
							end
						end
						if(gm == 3) then
							lbl = "Eat Every F@$king Chicken!";
							DS.data["lives"] = 0;
						end
						-- show spawn text for each game mode, except when game is over on hardcore
						if(DS.settings["game_mode"] == 1)then 
							DS.displaySpawnTitle(lbl, 1.5);
							DS.timer["spawn_timer"] = DS.timer["spawn_timer"] - 1;
							DS.drawText(" The HUD turns red when you need health!", 0.35, 0.00005, 0.29, false, 0, 255, 0, 0);
						elseif(DS.settings["game_mode"] == 3 and not DS.data["chicken_timer_up"]) then
							DS.displaySpawnTitle(lbl, 1.5);
							DS.timer["spawn_timer"] = DS.timer["spawn_timer"] - 1;
							DS.drawText(" The HUD turns red when you need health!", 0.35, 0.00005, 0.29, false, 0, 255, 0, 0);
						elseif(DS.settings["game_mode"] == 2 and DS.data["lives"] > 0) then
							DS.displaySpawnTitle(lbl, 1.5);
							DS.timer["spawn_timer"] = DS.timer["spawn_timer"] - 1;
							DS.drawText(" The HUD turns red when you need health!", 0.35, 0.00005, 0.29, false, 0, 255, 0, 0);
						end
					else
						DS.godOn(300);
						-- Game Mode 3 - Chicken!
						DS.timer["spawn_timer"] = 0;
						DS.toggle["spawn_dialog"] = false;
						if(DS.settings["game_mode"]==3) then
							DS.spawnChicken();
						end
					end
				end
			end
			-- set invinciblity using global state
			if (DS.settings["invincible"]) then
				ENTITY.SET_ENTITY_INVINCIBLE(playerPed, true);
			else 
				ENTITY.SET_ENTITY_INVINCIBLE(playerPed, false);
			end
			-- should we run the game logic?	
			if(DS.toggle["game_scanner"]) then
				-- Color HUD on Damage
				-- ====================
				local playerHealth = ENTITY.GET_ENTITY_HEALTH(playerPed);
				--print("PlayerHealth:"..playerHealth);
				if(playerHealth < 170) then
					r_ = 255;
					g_ = 0;
					b_ = 0;
				else
					r_ = 0;
					g_ = 0;
					b_ = 0;
				end
				-- Show Health Packs left
				-- ========================
				DS.drawHealthPackASCIILine();
				-- invincibility HUD
				-- ==================
				if(DS.toggle["godmode"]) then
					if(DS.timer["godmode"] > 0) then
						DS.timer["godmode"] = DS.timer["godmode"] - 1;
						local t = DS.timer["godmode"] / 10;
							local ln = "";
						for i=1, t do
						  ln = ln .. "|";
						end
						ln = "Invincible: "..ln;
						DS.drawText(ln, 0.0, 0.2, 0.4, false, 0, 255, 255, 0);
					else
						DS.godOff();
						DS.toggle["godmode"] = false;
						DS.timer["godmode"] = 0;
					end
				else
					-- print("godmode off");
				end
				-- CHICHEN!
				-- =========
				if(DS.data["chicken_in_play"]) then
					DS.drawText("Get the Chicken! ["..DS.data["chicken_zombies"].."]", 0.53, 0.00005, 0.3, false, 0, 255, 255, 255);
					-- chicken countdown timer
					-- ========================
					if(DS.toggle["chicken_is_loose"]) then
						if(DS.timer["chicken"] > 0) then
							DS.timer["chicken"] = DS.timer["chicken"] - 1;
							if(DS.timer["chicken"] < 1000) then
								DS.drawText(DS.timer["chicken"], 0.49, 0.00005, 1.0, false, 1, 255, 0, 0);
							else
								DS.drawText(DS.timer["chicken"], 0.49, 0.00005, 0.5, false, 1, 255, 0, 0);
							end
						else
							DS.timer["chicken"] = 0;
							DS.data["chicken_timer_up"] = true;
						end
					end
					if(DS.data["chicken_timer_up"]) then
						DS.drawText("YOU FAILED!", 0.4, 0.49, 4.2, true, 0, 255, 0, 0);
						DS.gameover();
						--DS.data["final_score"] = bonus;
					end
				else
					if(DS.settings["game_mode"] == 3) then
						DS.spawnChicken();
					end
				end
				-- let's fail-safe if anything is out of place
				if(DS.settings["game_mode"] == nil) then
					DS.settings["game_mode"] = 0;
				end
				-- set up score board
				-- ==================
				if(DS.settings["game_mode"] == 1) then
					DS.drawText(" Deaths:"..DS.data["deaths"].."\n", 0.70, 0.00005, 0.3, false, 0, r_, g_, b_);
					DS.drawText(" [Space] to end", 0.53, 0.00005, 0.3, false, 0, 255, 255, 255);
				end
				local kills = #DS.data["finished_wave"] * 4;
				local deathTally = "";
				if (DS.settings["game_mode"] == 2) then
					deathTally = " Deaths:"..DS.data["deaths"].."\n Lives:"..DS.data["lives"];
				end
				local chickenTally = " ";
				if(DS.settings["game_mode"] == 3) then
					chickenTally = " Chickens:"..DS.data["chicken_total"] ;
				end
				local modeName = "";
				if(DS.settings["game_mode"] == 1) then modeName=" MayHem\n ------------"; end
				if(DS.settings["game_mode"] == 2) then modeName=" HardCore\n --------------"; end
				if(DS.settings["game_mode"] == 3) then modeName=" Chicken\n ---------------"; end
				DS.drawText(modeName.."\n Waves:"..#DS.data["finished_wave"].."\n Kills:"..kills.."\n Max-multi:"..DS.data["max_num_Dank"].."\n"..deathTally..chickenTally, 0.58, 0.00005, 0.3, false, 0, r_, g_, b_);
				DS.drawText("LEVEL:"..DS.data["level"], 0.0, 0.05, 0.6, false, 0, r_, g_, b_);
				DS.drawText("SCORE:"..DS.data["score"], 0.0, 0.76, 0.6, false, 0, r_, g_, b_);
				--if(DS.settings["cops_ignore"])	then
				--	DS.drawText("\"No Cops!\" - Edna Moles", 0.3, 0.00005, 0.2, false, 0, r_, g_, b_);
				--else
				--	DS.drawText("Cops on", 0.3, 0.00005, 0.2, false, 0, r_, g_, b_);
				--end
				-- DANK SCANNER
				-- =============
				-- scan and track all unique peds
				-- when the timer reaches 0, raise the dead as Dank
				if(DS.timer["pedCheck"] == 0) then
					DS.raiseTheDoomed();
					DS.timer["pedCheck"] = DS.settings["pedCheckDelay"];
				else
					DS.timer["pedCheck"] = DS.timer["pedCheck"] - 1;
				end
				-- check if unique list of peds are dead
				if(DS.timer["deathCheck"] == 0) then
					DS.checkSeen();
					DS.timer["deathCheck"] =  DS.settings["deathCheckDelay"];
					DS.getScore();
					-- if chicken is in play, it will spawn it's own zombies
					if(DS.data["chicken_in_play"]) then
						-- spawn a new zombie
						local coord = ENTITY.GET_ENTITY_COORDS(DS.data["chicken"], false);
						local z = DS.Zombie(coord);
						DS.data["chicken_zombies"] = DS.data["chicken_zombies"] + 1;
						print("Chicken created zombie!");
						DS.playSound();
						if(DS.toggle["chicken_free_roam"]) then
							ENTITY.FREEZE_ENTITY_POSITION(DS.data["chicken"], true);
						else 
							ENTITY.FREEZE_ENTITY_POSITION(DS.data["chicken"], false);
						end
					end
				else
					-- DANK SPAWN TIMER HUD 
					-- =====================
					DS.timer["deathCheck"] = DS.timer["deathCheck"] - 1;
					if(DS.timer["deathCheck"] < 10) then
						--DS.data["show_hud"] = false;
						DS.drawText("DANK SPAWN!", 0.94, 0.49, 0.49, false, 0, 255, 255, 0);
						wait(50); -- flash the UI (simple hack)
					else
						if(playerHealth < 170) then
							DS.drawText("["..DS.timer["deathCheck"].."]", 0.94, 0.49, 0.49, false, 0, 255, 0, 0);
						else
							DS.drawText("["..DS.timer["deathCheck"].."]", 0.94, 0.49, 0.49, false, 0, 255, 255, 255);
						end
					end
				end
				-- update the mini-map blips
				-- ==========================
				if (DS.timer["blip"] == 0) then
					DS.updateBlipsForDank();
					DS.timer["blip"] = DS.settings["blip_update_delay"];
				else
					DS.timer["blip"] = DS.timer["blip"] - 1;
				end	
				-- new level check
				-- ================
				if(DS.toggle["new_level_reached"]) then
					if (DS.timer["new_level_reached"] < 500) then
						DS.drawText("New Level!", 0.20, 0.49, 1.0, true, 1, 255, 255, 0);
						if(DS.data["level"] == 2) then
							DS.drawText("You found a dope Health Flask!\nDrink concentrate to get your groove back on.", 0.30, 0.49, 0.5, true, 0, 255, 0, 0);
							DS.data["has_flask"] = true;
						end
						DS.timer["new_level_reached"] = DS.timer["new_level_reached"] + 1;
					else
						DS.timer["new_level_reached"] = 0;
						DS.toggle["new_level_reached"] = false;
						
					end
				end
				-- give out reward
				-- ================
				if(DS.data["reward_earned"]) then
					if(DS.data["reward_not_claimed"]) then
						if(get_key_pressed(75)) then -- 'K'
							print("spwan reward");
							DS.giveReward();
							DS.data["reward_not_claimed"] = false;
							DS.data["reward_earned"] = false;
							wait(2000);
						end
						if (DS.data["level"] == 1) then
							DS.data["reward_vech_name"] = "Annihilator";
						elseif(DS.data["level"] == 2) then
							DS.settings["health_as_a_resource"] = true;
							DS.data["reward_vech_name"] = "Bulldozer";
						elseif(DS.data["level"] == 3) then
							DS.data["reward_vech_name"] = "Tank";
						elseif(DS.data["level"] == 4) then
							DS.data["reward_vech_name"] = "Annihilator";
						elseif(DS.data["level"] == 5) then
							DS.data["reward_vech_name"] = "Annihilator";
						end
						DS.drawText(" [k] Spawn "..DS.data["reward_vech_name"], 0.75, 0.0005, 0.37, false, 1, 255, 255, 0);
					end
				end
				
				--DS.drawText(" [N] Toggle time", 0.77, 0.0005, 0.37, false, 1, 255, 255, 0);
				
			else-- print("TICK::scanner_false");
			end -- end scanner
			-- ====================
			-- key event listeners
			-- ====================
			-- Game Mode: Mayhem action key
			if(get_key_pressed(DS.settings["key_1"])) then -- 1
				if(DS.settings["game_mode"] == 0) then
					print("1 key pressed");
					print("Setting game mode to 1");
					DS.settings["game_mode"] = 1;
					DS.data["wave_progression"] = true;
					DS.giveAllWeapons();
					wait(1000);
				end
			end
			-- Game Mode: HardCore action key
			if(get_key_pressed(DS.settings["key_2"])) then -- 2
				if(DS.settings["game_mode"] == 0) then				
					print("2 key pressed");
					print("Setting game mode to 2");
					DS.settings["game_mode"] = 2;
					DS.data["lives"] = 3;
					DS.data["wave_progression"] = true;
					DS.giveLoadout();
					wait(1000);
				end
			end
			-- Game Mode: Chicken action key
			if(get_key_pressed(DS.settings["key_3"])) then -- 3
				if(DS.settings["game_mode"] == 0) then
					print("3 key pressed");
					print("Setting game mode to 3");
					WEAPON.GIVE_DELAYED_WEAPON_TO_PED(playerPed, GAMEPLAY.GET_HASH_KEY("WEAPON_ASSAULTSHOTGUN"), 200, false);
					DS.settings["game_mode"] = 3;
					DS.data["wave_progression"] = true;
					DS.settings["health_as_a_resource"] = false;
					DS.settings["cops_ignore"] = true;
					DS.giveLoadout();
					wait(1000);
				end
			end
			-- help screen action key
			if(get_key_pressed(DS.settings["key_help"])) then -- h
				print("h key pressed");
				print("Showing help...");
				if(DS.settings["game_mode"] == 0) then
					if (not DS.data["show_help"]) then
						print("help is false, setting true");
						DS.settings["game_mode"] = 0;
						DS.data["show_help"] = true;
					else
						print("help is true, setting false");
						DS.settings["game_mode"] = 0;
						DS.data["show_help"] = false;
					end
					wait(1000);
				else
					print("Help is not available, game mode active");
				end
			end
			-- Drink health juice action key
			if(get_key_pressed(74)) then -- 'J'	
				if(DS.settings["game_mode"] > 0) then
					print("J pressed");
					if (DS.data["health_count"] > 0) then
						DS.spawnHealth();
						wait(1000);
					end
				end
			end	
			-- last blood stain action key
			if(get_key_pressed(76)) then -- 'L'
				if(DS.settings["game_mode"] > 0) then
					DS.godOn(500);
					DS.teleport_to_coords_before_death()
					print("L key pressed, teleport");
					wait(1000);
				end
			end
			-- end game during Mayhem action key
			if(get_key_pressed(32)) then -- space
				if(DS.settings["game_mode"] > 0) then
					print("space key pressed");
					print("Setting game mode to end game");
					if(DS.settings["game_mode"] == 1) then
						DS.gameover();
					end
					wait(1000);
				end
			end
			-- ignore cops toggle action key
			--if(get_key_pressed(78)) then -- 'N'
				--if (DS.settings["cops_ignore"]) then
				--	DS.settings["cops_ignore"] = false;
				--	print("KeyPress::N::ignore_cops")
				--else 
				--	DS.settings["cops_ignore"] = true;
				--	print("KeyPress::N::ignore_cops");    
				--end
				--wait(1000);
			--end
			--if(get_key_pressed(78)) then -- 'N'
			--	local time_ = "normal";
			--	if(DS.data["slow_time"]) then
			--		DS.normalTime();
			--		DS.data["slow_time"] = false;
			--	else
			--		DS.data["slow_time"] = true;
			--		DS.slowTime();
			--	end
			--	wait(1000);
			--end 
			
			 
			--	if(get_key_pressed(74)) then -- j
			--		if (DS.toggle["chicken_free_roam"]) then
			--			DS.toggle["chicken_free_roam"] = false;
			--			print("KeyPress::J::chicken is now frozen")
			--		else 
			--			DS.toggle["chicken_free_roam"] = true;
			--			print("KeyPress::J::chicken is now loose!");    
			--		end
			--		wait(1000);
			--	end
		end	-- player exists and not dead
	end -- playgame
end -- tick
function DS.force_carexplode()
	local playerPed = PLAYER.PLAYER_PED_ID();
	local PedTab,PedCount = PED.GET_PED_NEARBY_PEDS(playerPed, 1, 1);
	local VehTab,VehCount = PED.GET_PED_NEARBY_VEHICLES(playerPed, 1);
	local count = 0;
	for k,v in ipairs(VehTab)do 
		local PlayerVeh = PED.IS_PED_IN_VEHICLE(playerPed, v, false)
		if(PlayerVeh == true)then
		else
			VEHICLE.EXPLODE_VEHICLE(v, true, true);
			print("explode car");
		end
	end
end
function DS.liftPeds()
	local range = 30;
	local player = PLAYER.PLAYER_PED_ID() 
	local pedTable1,Count = PED.GET_PED_NEARBY_PEDS(player, 1, 1);
	for j,d in ipairs(pedTable1) do 
		-- ped, forceType (1), x, y, z, xrot, yrot, zrot, (BOOLS)
		ENTITY.APPLY_FORCE_TO_ENTITY(d, 1, -5, 5, 1, 0,0,0, true, false, true, true, true, true);
	end
end
function DS.gameover()
	print("DS::GAMEOVER mode:"..DS.settings["game_mode"]);
	print("DS::GAMEOVER chickens:"..DS.data["chicken_total"]);
	DS.data["final_kills"] = #DS.data["finished_wave"] * 4;
	DS.data["final_waves"] = #DS.data["finished_wave"];
	DS.data["final_score"] = DS.data["score"];
	DS.settings["invincible"] = true;
	ENTITY.FREEZE_ENTITY_POSITION(PLAYER.PLAYER_PED_ID() , true);
	DS.data["playGame"] = false;
	DS.toggle["game_scanner"] = false;
	DS.data["game_over"] = true;
    --DS.killEmAll();
end
function DS.slowTime()
	GAMEPLAY.SET_TIME_SCALE(50 / 100);
end
function DS.normalTime()
	GAMEPLAY.SET_TIME_SCALE(100);
end
function DS.unload()
	DS.removeBlips();
    DS.killEmAll();
	print("Dank Souls was unloaded - See you in hell.");
end
function DS.onload()
	print("I live...");
end
	
return DS;